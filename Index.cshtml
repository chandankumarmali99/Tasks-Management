
@{
    ViewBag.Title = "Task Management";
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<div class="container">
    <div class="row mb-3">
        <div class="row mb-3">
            <div class="col-md-6">
                <h3>Task Management System</h3>
            </div>
            <div class="col-md-6 text-end">
                <button id="addTaskBtn" class="btn btn-primary">
                    Add New Task
                </button>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" id="searchText" class="form-control" placeholder="Search tasks..." />
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-primary" id="SearchTask" onclick="SearchTask()">Search</button>
            </div>
        </div>
    </div>

    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Description</th>
                <th>Due Date</th>
                <th>Status</th>
                <th>Remarks</th>
                <th>Created On</th>
                <th>Created By</th>
                <th>Updated On</th>
                <th>Updated By</th>
                <th>Action</th> <!-- NEW -->
            </tr>
        </thead>
        <tbody id="taskTableBody">
        </tbody>
    </table>

</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="taskModalLabel">Add/Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="TaskId" name="TaskId" value="0" />
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="TaskTitle" name="TaskTitle" placeholder="Task Title" required>
                        <label for="TaskTitle">Task Title</label>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea class="form-control" placeholder="Task Description" id="TaskDescription" name="TaskDescription" style="height:100px"></textarea>
                        <label for="TaskDescription">Task Description</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="date" class="form-control" id="TaskDueDate" name="TaskDueDate">
                        <label for="TaskDueDate">Due Date</label>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select" id="TaskStatus" name="TaskStatus">
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                        <label for="TaskStatus">Status</label>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea class="form-control" placeholder="Remarks" id="TaskRemarks" name="TaskRemarks" style="height:100px"></textarea>
                        <label for="TaskRemarks">Remarks</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnSave" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

</div>


<script>

    var modal;

    $(document).ready(function () {
        loadTasks();

        $("#addTaskBtn").click(function () {
            $("#taskForm")[0].reset();
            $("#TaskId").val(0);
            $("#taskModalLabel").text("Add Task");
            modal = new bootstrap.Modal(document.getElementById('taskModal'));
            modal.show();
        });

        $("#btnSave").click(function () {
            SaveTask();
        });
    });

    // ================= LOAD TASKS =================
    function loadTasks() {
        $.ajax({
            url: '/Task/GetAllTasks',
            type: 'GET',
            success: function (data) {
                var rows = '';
                $.each(data, function (i, item) {
                    rows += `
                    <tr>
                        <td>${item.TaskId}</td>
                        <td>${item.TaskTitle}</td>
                        <td>${item.TaskDescription}</td>
                        <td>${formatDate(item.TaskDueDate)}</td>
                        <td>${item.TaskStatus}</td>
                        <td>${item.TaskRemarks}</td>
                        <td>${formatDate(item.CreatedOn)}</td>
                        <td>${item.CreatedBy ?? ''}</td>
                        <td>${formatDate(item.UpdatedOn)}</td>
                        <td>${item.UpdatedBy ?? ''}</td>
                        <td>
                            <button class="btn btn-sm btn-primary"
                                onclick="editTask(${item.TaskId})">Edit</button>
                            <button class="btn btn-sm btn-danger ms-1"
                                onclick="deleteTask(${item.TaskId})">Delete</button>
                        </td>
                    </tr>`;
                });
                $('#taskTableBody').html(rows);
            }
        });
    }

    // ================= FORMAT DATE =================
    function formatDate(date) {
        if (!date) return '';
        var ms = parseInt(date.replace(/\/Date\((\d+)\)\//, "$1"));
        var d = new Date(ms);
        return d.toLocaleDateString('en-GB'); // dd/mm/yyyy
    }

    // ================= EDIT =================
    function editTask(id) {
        $.ajax({
            url: '/Task/GetTaskById',
            type: 'GET',
            data: { id: id },
            success: function (res) {

                $('#TaskId').val(res.TaskId);
                $('#TaskTitle').val(res.TaskTitle);
                $('#TaskDescription').val(res.TaskDescription);
                $('#TaskStatus').val(res.TaskStatus);
                $('#TaskRemarks').val(res.TaskRemarks);

                if (res.TaskDueDate) {
                    var ms = res.TaskDueDate.indexOf('Date') !== -1
                        ? parseInt(res.TaskDueDate.replace(/\/Date\((\d+)\)\//, "$1"))
                        : Date.parse(res.TaskDueDate);

                    var d = new Date(ms);
                    var f = d.getFullYear() + '-' +
                        String(d.getMonth() + 1).padStart(2, '0') + '-' +
                        String(d.getDate()).padStart(2, '0');

                    $('#TaskDueDate').val(f);
                }

                $('#taskModalLabel').text('Edit Task');
                modal = new bootstrap.Modal(document.getElementById('taskModal'));
                modal.show();
            }
        });
    }

    // ================= DELETE =================
    function deleteTask(id) {
        if (!confirm("Are you sure?")) return;

        $.ajax({
            url: '/Task/DeleteTask',
            type: 'POST',
            data: { id: id },
            success: function () {
                loadTasks();
            }
        });
    }

    // ================= SEARCH =================
    function SearchTask() {
        $.ajax({
            url: '/Task/SearchTask',
            type: 'GET',
            data: { taskTitle: $('#searchText').val() },
            success: function (data) {
                var rows = '';
                $.each(data, function (i, item) {
                    rows += `
                           <tr>
                               <td>${item.TaskId}</td>
                               <td>${item.TaskTitle}</td>
                               <td>${item.TaskDescription}</td>
                               <td>${formatDate(item.TaskDueDate)}</td>
                               <td>${item.TaskStatus}</td>
                               <td>${item.TaskRemarks}</td>
                               <td>${formatDate(item.CreatedOn)}</td>
                               <td>${item.CreatedBy ?? ''}</td>
                               <td>${formatDate(item.UpdatedOn)}</td>
                               <td>${item.UpdatedBy ?? ''}</td>
                               <td>
                                   <button class="btn btn-sm btn-primary"
                                       onclick="editTask(${item.TaskId})">Edit</button>
                                   <button class="btn btn-sm btn-danger ms-1"
                                       onclick="deleteTask(${item.TaskId})">Delete</button>
                               </td>
                           </tr>`;
                      });
                      $('#taskTableBody').empty();
                      $('#taskTableBody').html(rows);
            }
        });
    }

    // ================= SAVE =================
    function SaveTask() {
        var taskObj = {
            TaskId: $("#TaskId").val(),
            TaskTitle: $("#TaskTitle").val(),
            TaskDescription: $("#TaskDescription").val(),
            TaskDueDate: $("#TaskDueDate").val(),
            TaskStatus: $("#TaskStatus").val(),
            TaskRemarks: $("#TaskRemarks").val()
        };

        $.ajax({
            url: '/Task/SaveTask',
            type: 'POST',
            data: taskObj,
            success: function (res) {
                if (res.success) {
                    $("#taskForm")[0].reset();
                    loadTasks();

                    var modalEl = document.getElementById('taskModal');
                    bootstrap.Modal.getInstance(modalEl).hide();
                }
            }
        });
    }

</script>
